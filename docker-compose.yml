services:

  n8n:
    image: "n8nio/n8n:${N8N_VERSION:-latest}"
    container_name: n8n
    restart: unless-stopped

    ports:
      - "5678:5678"

    environment:
      # --- Basic ---
      TZ: ${TZ:-America/New_York}

      # --- Database (Postgres) ---
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}

      # --- Encryption key (set this!) ---
      # Must be stable across restarts or stored creds can break.
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # --- Recommended for reverse proxy setups (optional) ---
      N8N_HOST: "${N8N_HOST}"
      N8N_PORT: "${N8N_PORT:-5678}"
      N8N_PROTOCOL: "${N8N_PROTOCOL:-http}"
      WEBHOOK_URL: "${N8N_PROTOCOL:-http}://${N8N_HOST}:${N8N_PORT:-5678}"

      # Remove when HTTPS is enabled:
      N8N_SECURE_COOKIE: "${N8N_SECURE_COOKIE:-false}"
      
      # --- N8N external runners
      N8N_RUNNERS_ENABLED: "${N8N_RUNNERS_ENABLED:-true}"
      N8N_RUNNERS_MODE: "${N8N_RUNNERS_MODE:-external}"
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: "${N8N_RUNNERS_BROKER_LISTEN_ADDRESS:-0.0.0.0}"
      N8N_RUNNERS_AUTH_TOKEN: "${N8N_RUNNERS_AUTH_TOKEN}"
      N8N_NATIVE_PYTHON_RUNNER: "${N8N_NATIVE_PYTHON_RUNNER:-true}"

      # --- Hardening / UX knobs (optional) ---
      # N8N_DIAGNOSTICS_ENABLED: "false"
      # N8N_PERSONALIZATION_ENABLED: "false"

    volumes:
      - /opt/n8n/data:/home/node/.n8n

    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    container_name: n8n-postgres
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

    # Exposing Postgres is OPTIONAL.
    # Purpose: allow TablePlus (or other SQL client) access from your LAN for convenience.
    # Risk: increases blast radius if a host on that network can reach this port.
    #
    # Mitigation plan:
    # - Use UniFi firewall rules to allow TCP/5432 only from your admin laptop IP
    #   (and drop other sources).
    #
    # Safer mode (no LAN exposure):
    # - Set POSTGRES_BIND_IP=127.0.0.1 and use SSH port forwarding when needed:
    #     ssh -L 5432:127.0.0.1:5432 tim@n8n
    ports:
      - "${POSTGRES_BIND_IP:-127.0.0.1}:5432:5432"

    volumes:
      - /opt/n8n/postgres:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$$POSTGRES_USER\" -d \"$$POSTGRES_DB\""]
      interval: 10s
      timeout: 5s
      retries: 10

  n8n-runners:
    image: "n8nio/runners:${N8N_VERSION:-latest}"
    container_name: n8n-runners
    restart: unless-stopped

    environment:
      N8N_RUNNERS_TASK_BROKER_URI: "http://n8n:5679"
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      
    depends_on:
      - n8n
